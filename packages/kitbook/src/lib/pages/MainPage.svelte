<script lang="ts">
  import '../styles/kb-prose.css'
  import { Button } from 'svelte-pieces'
  import EditInGithub from '../components/EditInGithub.svelte'
  import { openComponent, openComposition, openSvx, openVariants } from '../open/openFiles'
  import Layout from '../layout/Layout.svelte'
  import type { LayoutLoadResult } from '../layout/layoutLoad'
  import Variants from './Variants.svelte'
  import Compositions from './Compositions.svelte'
  import type { MainPageLoadResult } from './mainPageLoad'
  import { dev } from '$app/environment'
  import { page } from '$app/stores'

  export let data: MainPageLoadResult & LayoutLoadResult

  const { viewports: kitbookViewports, languages, githubURL, viewer: { __internal: { viteBase } } } = data.settings
  const { pagesStore } = data
  $: pageFromHMR = $pagesStore?.[data.pageKey]

  let { variantsModule } = data.loadedModules
  $: if (pageFromHMR?.loadVariants?.loadModule)
    updateVariantsModule()
  else
    ({ variantsModule } = data.loadedModules)

  function updateVariantsModule() {
    pageFromHMR.loadVariants.loadModule().then((module) => {
      variantsModule = module
    }).catch((error) => {
      console.error(error)
    })
  }

  $: compositionModules = data.loadedModules.compositionsModules
  $: if (pageFromHMR?.loadCompositions)
    updateCompositions()

  function updateCompositions() {
    if (!compositionModules)
      compositionModules = {}
    Object.entries(pageFromHMR.loadCompositions).forEach(async ([compositionName, loadComposition]) => {
      compositionModules[compositionName] = (await loadComposition.loadModule())
    })
  }

  $: svx = data.loadedModules.svx
  $: if (pageFromHMR?.loadSvx)
    updateSvx()

  function updateSvx() {
    pageFromHMR.loadSvx.loadModule().then((module) => {
      svx = module.default
    }).catch((error) => {
      console.error(error)
    })
  }

  $: pathWithoutExtension = `.${data.page?.path.replace(/.\w+$/, '')}`
  $: title = ['+page', '+layout'].includes(data.page?.name) ? data.page?.path : data.page?.name
</script>

<Layout settings={data.settings} pages={data.pages} pathname={$page.url.pathname}>
  <main style="flex: 1" class="overflow-y-auto bg-white pt-2 px-2">
    {#if data.error}
      <div class="text-red">
        Error: {data.error}
      </div>
    {:else}
      {#if data.loadedModules.component}
        <div class="flex items-center font-semibold text-2xl mb-2">
          {title}

          {#if dev}
            <Button class="ml-1" onclick={() => openComponent(`${pathWithoutExtension}.svelte`, viteBase)} form="menu" color="black" title="Edit Component">
              <span class="i-vscode-icons-file-type-svelte text-2xl align--2px" />
            </Button>

            {#if !svx}
              <Button onclick={() => openSvx(`${pathWithoutExtension}.md`)} form="menu" color="black">
                <span class="i-vscode-icons-file-type-markdown align--6px text-2xl" /> Add Docs
              </Button>
            {/if}

            <Button
              onclick={() => {
                if (compositionModules) {
                  const name = prompt('What do you want to name this composition? (lowercase, no spaces or periods)')
                  if (name)
                    openComposition(pathWithoutExtension, `${name}.composition`)
                  return
                }
                openComposition(pathWithoutExtension, 'composition')
              }}
              form="menu"
              color="black"><span class="i-carbon-chart-treemap text-lg align--4px" /> Add Composition</Button>

            {#if !variantsModule?.variants}
              <Button onclick={() => openVariants(`${pathWithoutExtension}.svelte`)} form="menu" color="black"><span class="i-system-uicons-versions align--4px text-xl" /> Add Variant</Button>
            {/if}
          {/if}
        </div>
      {/if}

      {#if svx}
        <div class="kb-prose mb-8 max-w-1000px">
          <svelte:component this={svx} />
        </div>
      {/if}

      {#if compositionModules}
        <Compositions {compositionModules} {pathWithoutExtension} />
      {/if}

      {#if variantsModule?.variants}
        <Variants variants={variantsModule.variants} {pathWithoutExtension} viewports={variantsModule.viewports || kitbookViewports} {languages} />
      {/if}

      <EditInGithub path={data?.page?.path} {githubURL} />
    {/if}
  </main>
</Layout>
